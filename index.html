<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ–π –î–Ω–µ–≤–Ω–∏–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #1c1c1d; --card-bg: #2c2c2e; --text-color: #ffffff;
            --hint-color: #8e8e93; --accent-color: #0a84ff; --border-color: #3a3a3c;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; }
        .nav-tabs { display: flex; background: var(--card-bg); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: var(--hint-color); font-size: 13px; font-weight: bold; cursor: pointer; }
        .tab-btn.active { color: var(--accent-color); border-bottom: 2px solid var(--accent-color); }
        .container { padding: 10px; padding-bottom: 100px; }
        .section { display: none; }
        .section.active { display: block; }
        .meal-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .meal-title { font-size: 1.1rem; font-weight: bold; color: var(--accent-color); margin-bottom: 10px; }
        .group-header { font-size: 0.8rem; color: var(--hint-color); margin: 10px 0 5px; }
        .product-item {
            display: flex; justify-content: space-between; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 10px; background: var(--bg-color); margin-bottom: 5px; cursor: pointer;
        }
        .status-half { background: #ffd60a !important; color: #000; font-weight: bold; }
        .status-full { background: #32d74b !important; color: #000; font-weight: bold; }
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-color); color: #fff; margin-top: 5px; box-sizing: border-box; }
        label { display: block; margin-top: 10px; color: var(--hint-color); font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="showSection('nutrition')">–ü–∏—Ç–∞–Ω–∏–µ</button>
    <button class="tab-btn" onclick="showSection('activity')">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</button>
    <button class="tab-btn" onclick="showSection('measurements')">–ó–∞–º–µ—Ä—ã</button>
</div>

<div class="container">
    <div id="nutrition" class="section active"><div id="food-app"></div></div>
    <div id="activity" class="section">
        <div class="meal-card"><div class="meal-title">–®–∞–≥–∏</div><input type="number" id="steps" placeholder="0" oninput="localStorage.setItem('steps', this.value)"></div>
    </div>
    <div id="measurements" class="section">
        <div class="meal-card">
            <div class="meal-title">–ó–∞–º–µ—Ä—ã</div>
            <label>–í–µ—Å</label><input type="number" id="m_weight" oninput="localStorage.setItem('m_weight', this.value)">
            <label>–¢–∞–ª–∏—è</label><input type="number" id="m_waist" oninput="saveM(this)">
            <label>–ë–µ–¥—Ä–∞</label><input type="number" id="m_hips" oninput="saveM(this)">
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.text = "–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢";
    tg.MainButton.show();

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function saveM(el) { localStorage.setItem(el.id, el.value); }

    const dietData = [
        { name: "1Ô∏è‚É£ –ó–∞–≤—Ç—Ä–∞–∫", groups: [{ id: "1–∞", title: "–£–≥–ª–µ–≤–æ–¥—ã", items: [{ n: "–ì—Ä–µ—á–∫–∞", w: 40, c: 330 }, { n: "–û–≤—Å—è–Ω–∫–∞", w: 40, c: 350 }] }] },
        { name: "2Ô∏è‚É£ –û–±–µ–¥", groups: [{ id: "2–¥", title: "–ë–µ–ª–∫–∏", items: [{ n: "–ö—É—Ä–∏—Ü–∞", w: 175, c: 110 }, { n: "–†—ã–±–∞", w: 175, c: 90 }] }] }
        // –î–æ–±–∞–≤—å—Ç–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–≤–æ–∏ –ø—Ä–æ–¥—É–∫—Ç—ã —Å—é–¥–∞ –≤ —Ç–∞–∫–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ
    ];

    let eaten = JSON.parse(localStorage.getItem('eaten_v3')) || {};

    function eat(groupId, itemName) {
        const key = groupId + "_" + itemName;
        const cur = eaten[key] || 0;
        eaten[key] = cur === 0 ? 0.5 : (cur === 0.5 ? 1 : 0);
        localStorage.setItem('eaten_v3', JSON.stringify(eaten));
        renderFood();
    }

    function renderFood() {
        const container = document.getElementById('food-app');
        let html = '';
        dietData.forEach(meal => {
            html += `<div class="meal-card"><div class="meal-title">${meal.name}</div>`;
            meal.groups.forEach(g => {
                html += `<div class="group-header">${g.title}</div>`;
                g.items.forEach(i => {
                    const val = eaten[g.id + "_" + i.n] || 0;
                    const cls = val === 0.5 ? 'status-half' : (val === 1 ? 'status-full' : '');
                    html += `<div class="product-item ${cls}" onclick="eat('${g.id}', '${i.n}')">
                        <span>${i.n}</span><span>${val > 0 ? val + ' –ø–æ—Ä—Ü.' : i.w + '–≥'}</span>
                    </div>`;
                });
            });
            html += `</div>`;
        });
        container.innerHTML = html;
    }

    tg.MainButton.onClick(() => {
        try {
            let report = "üìä –û–¢–ß–ï–¢ –ó–ê –°–ï–ì–û–î–ù–Ø\n\n";
            report += "üë£ –®–∞–≥–∏: " + (localStorage.getItem('steps') || 0) + "\n";
            report += "‚öñÔ∏è –í–µ—Å: " + (localStorage.getItem('m_weight') || "-") + " –∫–≥\n\nüçé –ï–î–ê:";
            
            dietData.forEach(m => {
                m.groups.forEach(g => {
                    g.items.forEach(i => {
                        const v = eaten[g.id + "_" + i.n] || 0;
                        if(v > 0) report += `\n- ${i.n}: ${v} –ø–æ—Ä—Ü.`;
                    });
                });
            });

            tg.sendData(report); // –°–∞–º–∞—è –≤–∞–∂–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
            localStorage.clear();
        } catch (e) {
            alert("–û—à–∏–±–∫–∞: " + e.message);
        }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ –∏–Ω–ø—É—Ç—ã
    window.onload = () => {
        ['steps', 'm_weight', 'm_waist', 'm_hips'].forEach(id => {
            const v = localStorage.getItem(id);
            if(v) document.getElementById(id).value = v;
        });
        renderFood();
    };
</script>
</body>
</html>
