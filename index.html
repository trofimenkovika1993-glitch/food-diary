<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î–Ω–µ–≤–Ω–∏–∫ –∑–¥–æ—Ä–æ–≤—å—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #1c1c1d;
            --card-bg: #2c2c2e;
            --text-color: #ffffff;
            --hint-color: #8e8e93;
            --accent-color: #0a84ff;
            --border-color: #3a3a3c;
        }

        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; font-size: 16px; }
        
        .nav-tabs { display: flex; background: var(--card-bg); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-color); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: var(--hint-color); font-size: 13px; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        
        .container { padding: 10px; padding-bottom: 100px; }
        .section { display: none; }
        .section.active { display: block; }

        .meal-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .meal-title { font-size: 1.2rem; font-weight: bold; color: var(--accent-color); margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        
        .group-header { font-size: 0.85rem; font-weight: 600; color: var(--hint-color); margin: 15px 0 8px 0; display: flex; justify-content: space-between; }
        .products-list { display: flex; flex-direction: column; gap: 6px; }
        
        .product-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 14px; border: 1px solid var(--border-color);
            border-radius: 10px; background: var(--bg-color); -webkit-tap-highlight-color: transparent;
        }
        
        .status-half { background: #ffd60a !important; color: #000; border-color: #ffd60a; font-weight: bold; }
        .status-full { background: #32d74b !important; color: #000; border-color: #32d74b; font-weight: bold; }

        label { display: block; margin-top: 15px; color: var(--hint-color); font-size: 0.9rem; }
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-color); color: #fff; font-size: 16px; box-sizing: border-box; margin-top: 5px; }
    </style>
</head>
<body>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="showSection('nutrition')">–ü–∏—Ç–∞–Ω–∏–µ</button>
    <button class="tab-btn" onclick="showSection('activity')">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</button>
    <button class="tab-btn" onclick="showSection('measurements')">–ó–∞–º–µ—Ä—ã</button>
</div>

<div class="container">
    <div id="nutrition" class="section active">
        <div id="food-app"></div>
    </div>

    <div id="activity" class="section">
        <div class="meal-card">
            <div class="meal-title">–î–≤–∏–∂–µ–Ω–∏–µ</div>
            <label>–®–∞–≥–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</label>
            <input type="number" id="steps" placeholder="0" oninput="saveInput(this)">
        </div>
    </div>

    <div id="measurements" class="section">
        <div class="meal-card">
            <div class="meal-title">–¢–µ–ª–æ</div>
            <label>–í–µ—Å (–∫–≥)</label><input type="number" step="0.1" id="m_weight" oninput="saveInput(this)">
            <label>–ì—Ä—É–¥—å (—Å–º)</label><input type="number" id="m_chest" oninput="saveInput(this)">
            <label>–¢–∞–ª–∏—è (—Å–º)</label><input type="number" id="m_waist" oninput="saveInput(this)">
            <label>–ë–µ–¥—Ä–∞ (—Å–º)</label><input type="number" id="m_hips" oninput="saveInput(this)">
            <label>–ü–ª–µ—á–æ (—Å–º)</label><input type="number" id="m_shoulder" oninput="saveInput(this)">
            <label>–ù–æ–≥–∞ (—Å–º)</label><input type="number" id="m_leg" oninput="saveInput(this)">
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.text = "–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢ –ó–ê –î–ï–ù–¨";
    tg.MainButton.show();

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö –ü–†–û–î–£–ö–¢–û–í
    const dietData = [
        {
            name: "1Ô∏è‚É£ –ü—Ä–∏–µ–º –ø–∏—â–∏",
            groups: [
                { id: "1–∞", title: "üìå –∞) –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã", items: [{ n: "–ë–æ–±–æ–≤—ã–µ", w: 40, c: 130 }, { n: "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", w: 140, c: 77 }, { n: "–ö—É–∫—É—Ä—É–∑–∞ —Å–≤–µ–∂–∞—è", w: 140, c: 86 }, { n: "–†–∏—Å (–Ω–µ —à–ª–∏—Ñ.)", w: 40, c: 340 }, { n: "–õ—é–±–∞—è –∫—Ä—É–ø–∞", w: 40, c: 330 }, { n: "–¶/–∑ –º—É–∫–∞", w: 40, c: 300 }, { n: "–•–ª–µ–±—Ü—ã", w: 60, c: 310 }, { n: "–¶/–∑ —Ö–ª–µ–±", w: 65, c: 250 }, { n: "–ú–∞–∫–∞—Ä–æ–Ω—ã —Ç–≤. —Å–æ—Ä—Ç–æ–≤", w: 40, c: 350 }, { n: "–õ–∞–≤–∞—à", w: 60, c: 270 }] },
                { id: "1–±", title: "üìå –±) –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã", items: [{ n: "–¢–≤–æ—Ä–æ–≥ 0.2%", w: 160, c: 80 }, { n: "–°—ã—Ä—ã", w: 30, c: 360 }, { n: "–°–º–µ—Ç–∞–Ω–∞ 15%", w: 65, c: 160 }, { n: "–ö–µ—Ñ–∏—Ä 1%", w: 270, c: 40 }, { n: "–ô–æ–≥—É—Ä—Ç 1%", w: 250, c: 50 }, { n: "–ú–æ–ª–æ–∫–æ 1%", w: 280, c: 42 }] },
                { id: "1–≤", title: "üìå –≤) –ß—Ç–æ —É–≥–æ–¥–Ω–æ / –§—Ä—É–∫—Ç—ã", items: [{ n: "–ß—Ç–æ —É–≥–æ–¥–Ω–æ / –°–Ω–µ–∫–∏", w: 100, c: 450 }, { n: "–§—Ä—É–∫—Ç—ã", w: 1000, c: 50 }, { n: "–ë–∞–Ω–∞–Ω—ã", w: 600, c: 95 }] }
            ]
        },
        {
            name: "2Ô∏è‚É£ –ü—Ä–∏–µ–º –ø–∏—â–∏",
            groups: [
                { id: "2–≥", title: "üìå –≥) –°–ª–æ–∂–Ω—ã–µ —É–≥–ª–µ–≤–æ–¥—ã", items: [{ n: "–ë–æ–±–æ–≤—ã–µ", w: 40, c: 130 }, { n: "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", w: 140, c: 77 }, { n: "–ö—É–∫—É—Ä—É–∑–∞ —Å–≤–µ–∂–∞—è", w: 140, c: 86 }, { n: "–†–∏—Å", w: 40, c: 340 }, { n: "–õ—é–±–∞—è –∫—Ä—É–ø–∞", w: 40, c: 330 }, { n: "–ú–∞–∫–∞—Ä–æ–Ω—ã —Ç–≤. —Å–æ—Ä—Ç–æ–≤", w: 40, c: 350 }] },
                { id: "2–¥", title: "üìå –¥) –ë–µ–ª–∫–∏", items: [{ n: "–¢–µ–ª—è—Ç–∏–Ω–∞", w: 165, c: 150 }, { n: "–ü–µ—á–µ–Ω—å", w: 165, c: 130 }, { n: "–§–∏–ª–µ –ø—Ç–∏—Ü—ã", w: 175, c: 110 }, { n: "–†—ã–±–∞ (–¥–æ 5%)", w: 175, c: 90 }, { n: "–†—ã–±–∞ (–∂–∏—Ä–Ω–∞—è)", w: 140, c: 200 }, { n: "2 —è–π—Ü–∞", w: 1, c: 155 }, { n: "–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã", w: 220, c: 85 }] },
                { id: "2–µ", title: "üìå –µ) –û–≤–æ—â–∏ / –ì—Ä–∏–±—ã", items: [{ n: "–û–≤–æ—â–∏ / –ó–µ–ª–µ–Ω—å", w: 300, c: 25 }, { n: "–ì—Ä–∏–±—ã", w: 300, c: 22 }] },
                { id: "2—ë", title: "üìå —ë) –ñ–∏—Ä—ã / –°–æ—É—Å—ã", items: [{ n: "–ú–∞—Å–ª–æ –ª—é–±–æ–µ", w: 10, c: 890 }, { n: "–ú–∞–π–æ–Ω–µ–∑", w: 13, c: 680 }, { n: "–ê–≤–æ–∫–∞–¥–æ", w: 55, c: 160 }, { n: "–û–ª–∏–≤–∫–∏", w: 70, c: 115 }, { n: "–ì–æ—Ä—á–∏—Ü–∞", w: 24, c: 60 }, { n: "–ö–µ—Ç—á—É–ø", w: 36, c: 90 }, { n: "–°–∞–ª–æ", w: 9, c: 800 }] }
            ]
        },
        {
            name: "3Ô∏è‚É£ –ü—Ä–∏–µ–º –ø–∏—â–∏",
            groups: [
                { id: "3–∂", title: "üìå –∂) –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã", items: [{ n: "–¢–≤–æ—Ä–æ–≥ 0.2%", w: 190, c: 80 }, { n: "–°—ã—Ä—ã", w: 40, c: 360 }, { n: "–°–º–µ—Ç–∞–Ω–∞ 15%", w: 75, c: 160 }, { n: "–ö–µ—Ñ–∏—Ä 1%", w: 330, c: 40 }, { n: "–ô–æ–≥—É—Ä—Ç 1%", w: 330, c: 50 }, { n: "–ú–æ–ª–æ–∫–æ 1%", w: 335, c: 42 }] },
                { id: "3–∑", title: "üìå –∑) –§—Ä—É–∫—Ç—ã –∏ —è–≥–æ–¥—ã", items: [{ n: "–§—Ä—É–∫—Ç—ã –∏ —è–≥–æ–¥—ã", w: 320, c: 50 }, { n: "–ë–∞–Ω–∞–Ω—ã/–í–∏–Ω–æ–≥—Ä–∞–¥", w: 190, c: 95 }] },
                { id: "3–∏", title: "üìå –∏) –û—Ä–µ—Ö–∏ –∏ —Å–µ–º–µ–Ω–∞", items: [{ n: "–ì—Ä–µ—Ü–∫–∏–µ –æ—Ä–µ—Ö–∏", w: 15, c: 650 }] }
            ]
        },
        {
            name: "4Ô∏è‚É£ –ü—Ä–∏–µ–º –ø–∏—â–∏",
            groups: [
                { id: "4–∏", title: "üìå –∏) –ë–µ–ª–∫–∏", items: [{ n: "–¢–µ–ª—è—Ç–∏–Ω–∞", w: 165, c: 150 }, { n: "–ü–µ—á–µ–Ω—å", w: 165, c: 130 }, { n: "–§–∏–ª–µ –ø—Ç–∏—Ü—ã", w: 175, c: 110 }, { n: "–†—ã–±–∞ (–¥–æ 5%)", w: 175, c: 90 }, { n: "–†—ã–±–∞ (–∂–∏—Ä–Ω–∞—è)", w: 140, c: 200 }, { n: "–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã", w: 220, c: 85 }] },
                { id: "4–π", title: "üìå –π) –û–≤–æ—â–∏ / –ì—Ä–∏–±—ã", items: [{ n: "–û–≤–æ—â–∏ –∏ –∑–µ–ª–µ–Ω—å", w: 300, c: 25 }, { n: "–ì—Ä–∏–±—ã", w: 300, c: 22 }] },
                { id: "4–∫", title: "üìå –∫) –ñ–∏—Ä—ã", items: [{ n: "–ú–∞—Å–ª–æ", w: 10, c: 890 }, { n: "–ú–∞–π–æ–Ω–µ–∑", w: 13, c: 680 }, { n: "–ê–≤–æ–∫–∞–¥–æ", w: 55, c: 160 }, { n: "–û–ª–∏–≤–∫–∏", w: 70, c: 115 }, { n: "–°–∞–ª–æ", w: 9, c: 800 }] }
            ]
        }
    ];

    // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó –ü–ê–ú–Ø–¢–ò
    let eaten = JSON.parse(localStorage.getItem('eaten_v2')) || {};

    function saveInput(el) {
        localStorage.setItem(el.id, el.value);
    }

    function eat(groupId, itemName) {
        const key = `${groupId}_${itemName}`;
        let groupSum = 0;
        for (let k in eaten) {
            if (k.startsWith(groupId + "_") && k !== key) groupSum += eaten[k];
        }

        const current = eaten[key] || 0;
        let next = 0;

        if (current === 0) {
            next = (groupSum + 0.5 <= 1) ? 0.5 : 0;
        } else if (current === 0.5) {
            next = (groupSum + 1 <= 1) ? 1 : 0;
        } else {
            next = 0;
        }

        eaten[key] = next;
        localStorage.setItem('eaten_v2', JSON.stringify(eaten));
        renderFood();
    }

    function renderFood() {
        const app = document.getElementById('food-app');
        let html = '';
        dietData.forEach(meal => {
            html += `<div class="meal-card"><div class="meal-title">${meal.name}</div>`;
            meal.groups.forEach(group => {
                html += `<div class="group-header"><span>${group.title}</span><span style="font-size:0.7rem">max 1.0</span></div><div class="products-list">`;
                group.items.forEach(item => {
                    const val = eaten[`${group.id}_${item.n}`] || 0;
                    const cls = val === 0.5 ? 'status-half' : (val === 1 ? 'status-full' : '');
                    const weightLabel = item.w === 1 ? '' : (val === 0.5 ? (item.w/2)+'–≥' : item.w+'–≥');
                    html += `<div class="product-item ${cls}" onclick="eat('${group.id}', '${item.n}')">
                        <span>${item.n}</span><span style="opacity:0.6; font-size:0.8rem">${val > 0 ? (val === 0.5 ? '¬Ω –ø–æ—Ä—Ü.' : '1 –ø–æ—Ä—Ü.') : weightLabel}</span>
                    </div>`;
                });
                html += `</div>`;
            });
            html += `</div>`;
        });
        app.innerHTML = html;
    }

    tg.MainButton.onClick(() => {
    try {
        console.log("–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞, –Ω–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...");
        
        const date = new Date().toLocaleDateString('ru-RU');
        const steps = localStorage.getItem('steps') || "0";
        const weight = localStorage.getItem('m_weight') || "-";
        
        let report = `üìÖ *–û–¢–ß–ï–¢ –ó–ê ${date}*\n\n`;
        report += `üë£ –®–∞–≥–∏: ${steps}\n`;
        report += `‚öñÔ∏è –í–µ—Å: ${weight} –∫–≥\n`;
        
        // –°–±–æ—Ä –∑–∞–º–µ—Ä–æ–≤
        const measurements = [
            {id: 'm_chest', l: '–ì—Ä—É–¥—å'},
            {id: 'm_waist', l: '–¢–∞–ª–∏—è'},
            {id: 'm_hips', l: '–ë–µ–¥—Ä–∞'},
            {id: 'm_shoulder', l: '–ü–ª–µ—á–æ'},
            {id: 'm_leg', l: '–ù–æ–≥–∞'}
        ];
        
        measurements.forEach(m => {
            const val = localStorage.getItem(m.id);
            if (val) report += `üìè ${m.l}: ${val} —Å–º\n`;
        });

        let totalCal = 0;
        let foodPart = "\nüçé *–ü–ò–¢–ê–ù–ò–ï:*";
        let hasFood = false;

        // –í–∞–∂–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ dietData –∏ eaten
        if (typeof dietData !== 'undefined' && eaten) {
            dietData.forEach(meal => {
                meal.groups.forEach(group => {
                    group.items.forEach(item => {
                        const val = eaten[`${group.id}_${item.n}`] || 0;
                        if (val > 0) {
                            hasFood = true;
                            const cals = item.w === 1 ? Math.round(item.c * val) : Math.round((item.c * item.w * val) / 100);
                            totalCal += cals;
                            foodPart += `\n‚Ä¢ ${item.n} (${val === 0.5 ? '¬Ω' : '1'} –ø–æ—Ä—Ü) ‚Üí ${cals} –∫–∫–∞–ª`;
                        }
                    });
                });
            });
        }

        if (hasFood) {
            report += foodPart + `\n\nüî• *–ò–¢–û–ì–û:* ${totalCal} –∫–∫–∞–ª`;
        } else {
            report += "\nüçé –î–∞–Ω–Ω—ã–µ –æ –µ–¥–µ –Ω–µ –≤–Ω–µ—Å–µ–Ω—ã";
        }

        // –°–ê–ú–´–ô –í–ê–ñ–ù–´–ô –ú–û–ú–ï–ù–¢:
        // –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ report - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
        console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞...");
        tg.sendData(String(report)); 
        
        // –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ —Ç–æ–ª—å–∫–æ –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–∫–∏
        localStorage.clear();

    } catch (error) {
        // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å, –≤—ã —É–≤–∏–¥–∏—Ç–µ –æ–∫–Ω–æ —Å –æ—à–∏–±–∫–æ–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ: " + error.message);
    }
});
</script>
</body>
</html>

